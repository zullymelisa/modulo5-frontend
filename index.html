<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener - Acorta tus enlaces</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <!-- Main Form Page -->
    <div class="container" id="mainPage">
        <div class="header">
            <div class="logo">ðŸ”—</div>
            <h1>URL Shortener</h1>
            <p class="subtitle">Acorta tus enlaces largos en segundos</p>
        </div>

        <form id="shortenForm">
            <div class="input-group">
                <label for="urlInput">Ingresa tu URL</label>
                <input 
                    type="url" 
                    id="urlInput" 
                    placeholder="https://ejemplo.com/tu-url-muy-larga" 
                    required
                >
            </div>

            <button type="submit" class="btn btn-primary" id="shortenBtn">
                <span>ðŸš€</span>
                <span>Acortar URL</span>
            </button>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Generando tu enlace corto...</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="result-box" id="resultBox">
            <div class="result-label">âœ¨ Tu URL acortada:</div>
            <div class="result-url">
                <a href="#" target="_blank" id="shortUrl"></a>
                <button class="btn-copy" id="copyBtn">Copiar</button>
            </div>
        </div>
    </div>

    <!-- Redirect logic moved to redirect.html to keep index.html focused on the main app -->

    <script>
        // ConfiguraciÃ³n de la API (valores generados por Terraform)
        const API_CONFIG = {
            SHORTEN_ENDPOINT: 'https://hwk68la162.execute-api.us-east-1.amazonaws.com/shorten',
            REDIRECT_ENDPOINT: 'https://hwk68la162.execute-api.us-east-1.amazonaws.com',
            // PÃ¡gina que procesa la redirecciÃ³n en el CDN
            REDIRECT_PAGE: 'https://d1w0l832are5e0.cloudfront.net/redirect.html',
            // Modo mock local: si true, la app no llama a una API remota y
            // guarda/lee los mapeos en localStorage (Ãºtil para probar offline).
            MOCK_MODE: false
        };

        // Estado para la redirecciÃ³n (intervalo) â€” evita condiciones de carrera
        let _redirectInterval = null;

        // Redirect logic has been moved to redirect.html

        // Handle URL shortening
        document.getElementById('shortenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            // Reset states
            document.getElementById('resultBox').classList.remove('show');
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('loading').classList.add('show');
            document.getElementById('shortenBtn').disabled = true;

            try {
                let data;

                if (API_CONFIG.MOCK_MODE) {
                    // Simular llamada a API en modo mock
                    await new Promise(r => setTimeout(r, 600));
                    const codigo = Math.random().toString(36).substring(2, 8);
                    data = { codigo };

                    // Guardar el mapeo local para permitir redirecciones en modo mock
                    try {
                        localStorage.setItem(`short_${data.codigo}`, url);
                    } catch (err) {
                        console.warn('No se pudo escribir en localStorage:', err);
                    }
                } else {
                    // Call API to shorten URL
                    const response = await fetch(API_CONFIG.SHORTEN_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: url })
                    });

                    if (!response.ok) {
                        throw new Error('Error al acortar la URL');
                    }

                    data = await response.json();
                    // If the API returns a code, we also save mapping locally for convenience
                    try {
                        if (data && data.codigo) localStorage.setItem(`short_${data.codigo}`, url);
                    } catch (err) {
                        console.warn('No se pudo escribir en localStorage:', err);
                    }
                }

                // Build a short URL in a robust way. The API may return different shapes:
                // - { codigo: 'abc123' }
                // - { codigo: 'abc123', shortUrl: 'https://...' }
                // - { shortcode: 'abc123' }
                // Prefer an explicit shortUrl from the API; otherwise build a redirect URL
                let code = data && (data.codigo || data.code || data.shortcode || data.shortCode || data.short);
                let shortUrl = null;
                if (data && data.shortUrl) {
                    shortUrl = data.shortUrl;
                } else if (code) {
                    // Use the redirect page with query param to keep CDN simple
                    shortUrl = `${API_CONFIG.REDIRECT_PAGE}?code=${encodeURIComponent(code)}`;
                } else if (data && data.url) {
                    // Defensive: if API returned a full URL under a different key
                    shortUrl = data.url;
                } else {
                    // Fallback: try to parse a code from any returned shortUrl-like value
                    const possible = data && (data.short || data.id || null);
                    if (possible) {
                        shortUrl = `${API_CONFIG.REDIRECT_PAGE}?code=${encodeURIComponent(possible)}`;
                    }
                }

                // Show result
                document.getElementById('shortUrl').href = shortUrl;
                document.getElementById('shortUrl').textContent = shortUrl;
                document.getElementById('resultBox').classList.add('show');

            } catch (error) {
                console.error('Error:', error);
                showError('No se pudo acortar la URL. Por favor intenta de nuevo.');
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('shortenBtn').disabled = false;
            }
        });

        // Copy to clipboard
        document.getElementById('copyBtn').addEventListener('click', async () => {
            const shortUrl = document.getElementById('shortUrl').textContent;
            const copyBtn = document.getElementById('copyBtn');
            
            try {
                await navigator.clipboard.writeText(shortUrl);
                copyBtn.textContent = 'âœ“ Copiado';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = 'Copiar';
                    copyBtn.classList.remove('copied');
                }, 2000);
            } catch (error) {
                console.error('Error al copiar:', error);
            }
        });

        // Redirect functionality lives in redirect.html now

        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>